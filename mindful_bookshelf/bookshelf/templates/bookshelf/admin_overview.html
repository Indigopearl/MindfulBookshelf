{% extends 'bookshelf/base.html' %}
{% load static %}
{% block title %}Admin Overview{% endblock %}
{% block content %}
    <div class="admin-overview">
        <h2>Add New Book</h2>
        <a href="{% url 'add_book' %}" target="_blank">Add New Book</a>
        <h2>Add New Category</h2>
        <a href="{% url 'add_category' %}" target="_blank">Add New Category</a>
        <h2>Books</h2>
        <input type="text" id="bookSearch" placeholder="Search Books">
        <select id="bookDropdown">
            <option value="" selected>Select Book</option>
            {% for book in books %}
                <option value="{{ book.id }}" data-available="{{ book.available }}">{{ book.title }}</option>
            {% endfor %}
        </select>
        <button id="showBookDetails">Show Book Details</button>
        <button id="toggleBookAvailability">Toggle Availability</button>
        <button id="deleteBook" style="display: none;">Delete Book</button>
        <h2>Users</h2>
        <div>
            {% if users %}
                <input type="text" id="userSearch" placeholder="Search Users">
                <select id="userDropdown">
                    <option value="" selected>Select User</option>
                    {% for user in users %}<option value="{{ user.id }}">{{ user.username }}</option>{% endfor %}
                </select>
                <button id="searchButton">Show User Details</button>
            {% else %}
                <p>No users available.</p>
            {% endif %}
        </div>
    </div>
    <div id="user-details-placeholder"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var bookDropdown = document.getElementById('bookDropdown');
            var bookSearchInput = document.getElementById('bookSearch');
            var userDropdown = document.getElementById('userDropdown');
            var userSearch = document.getElementById('userSearch');
            var toggleBookAvailabilityButton = document.getElementById('toggleBookAvailability');
            var deleteBookButton = document.getElementById('deleteBook');
    
            // Filter book dropdown based on search input
            bookSearchInput.addEventListener('input', function() {
                var searchTerm = this.value.toLowerCase();
                var options = bookDropdown.options;
                var foundMatch = false;
    
                for (var i = 1; i < options.length; i++) {
                    var bookTitle = options[i].text.toLowerCase();
                    if (bookTitle.includes(searchTerm)) {
                        options[i].style.display = "block";
                        bookDropdown.selectedIndex = i; // Autofill with first matching book
                        foundMatch = true;
                        break; // Stop after finding the first match
                    } else {
                        options[i].style.display = "none";
                    }
                }
                if (!foundMatch) {
                    bookDropdown.selectedIndex = 0; // Reset to "Select Book"
                    alert("Book not found."); // Notify user if no match found
                }
            });
    
            // Handle selecting a book from the dropdown
            bookDropdown.addEventListener('change', function() {
                var selectedBookId = this.value;
                var selectedBook = bookDropdown.options[bookDropdown.selectedIndex];
                var isAvailable = selectedBook.getAttribute('data-available') === 'True';
                if (selectedBookId) {
                    // Update visibility of delete button based on availability
                    deleteBookButton.style.display = isAvailable ? 'none' : 'block';
                }
            });
    
            // Filter user dropdown based on search input
            userSearch.addEventListener('input', function() {
                var searchTerm = this.value.toLowerCase();
                var options = userDropdown.options;
                var foundMatch = false;
    
                for (var i = 1; i < options.length; i++) {
                    var username = options[i].text.toLowerCase();
                    if (username.startsWith(searchTerm)) {
                        options[i].style.display = "block";
                        userDropdown.selectedIndex = i; // Autofill with first matching user
                        foundMatch = true;
                        break; // Stop after finding the first match
                    } else {
                        options[i].style.display = "none";
                    }
                }
                if (!foundMatch) {
                    userDropdown.selectedIndex = 0; // Reset to "Select User"
                    alert("User not found."); // Notify user if no match found
                }
            });
    
            // Handle selecting a user from the dropdown for existing books
            userDropdown.addEventListener('change', function() {
                // Get the selected user ID from the dropdown value
                var selectedUserId = this.value;
                if (selectedUserId) {
                    // Update the edit book URL in the existing book list to prefill the user field
                    var bookLinks = document.querySelectorAll('.admin-overview ul a');
                    for (var i = 0; i < bookLinks.length; i++) {
                        var bookLink = bookLinks[i];
                        var urlParams = new URLSearchParams(bookLink.search);
                        urlParams.set('prefill_user', selectedUserId);
                        bookLink.search = urlParams.toString();
                    }
                }
            });
    
            // Handle toggle availability button click
            toggleBookAvailabilityButton.addEventListener('click', function() {
                var selectedBookId = bookDropdown.value;
                if (selectedBookId) {
                    var selectedBook = bookDropdown.options[bookDropdown.selectedIndex];
                    var isAvailable = selectedBook.getAttribute('data-available') === 'True';
                    // Update book availability text
                    selectedBook.setAttribute('data-available', isAvailable ? 'False' : 'True');
                    selectedBook.textContent = isAvailable ? 'Offline' : 'Online';
                } else {
                    alert("Please select a book.");
                }
            });
    
            // Handle delete book button click
            deleteBookButton.addEventListener('click', function() {
                var confirmed = confirm("Are you sure you want to delete this book?");
                if (confirmed) {
                    var selectedBookId = bookDropdown.value;
                    if (selectedBookId) {
                        // Implement logic to delete book
                        var url = "{% url 'delete_book' %}?book_id=" + selectedBookId;
                        window.location.href = url;
                    }
                }
            });
    
            // Handle search button click for users (optional)
            document.getElementById('searchButton').addEventListener('click', function() {
                var selectedUserId = userDropdown.value;
                if (selectedUserId) {
                    var url = "{% url 'user_details' %}?id=" + selectedUserId;
                    // Open URL in a new popup window with options (optional)
                    window.open(url, '_popup', 'width=600,height=400'); 
                } else {
                    alert("Please select a user.");
                }
            });
    
            // ... other existing functions ...
        });
    </script>
{% endblock %}
