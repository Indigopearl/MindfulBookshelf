{% extends 'bookshelf/base.html' %}
{% load static %}
{% block title %}Admin Overview{% endblock %}
{% block content %}
    <div class="admin-overview">
        <h2>Add New Book</h2>
        <button id="addNewBook">Add New Book</button>
        <h2>Add New Category</h2>
        <a href="{% url 'add_category' %}" target="_blank">Add New Category</a>
        <h2>Books</h2>
        <input type="text" id="bookSearch" placeholder="Search Books">
        <select id="bookDropdown">
            <option value="" selected>Select Book</option>
            {% for book in books %}
                <option value="{{ book.id }}" data-available="{{ book.available }}">{{ book.title }}</option>
            {% endfor %}
        </select>
        <button id="showBookDetails"
                data-book-details-url="{% url 'book_detail' book_id=0 %}">Show Book Details</button>
        <h2>Users</h2>
        <div>
            {% if users %}
                <input type="text" id="userSearch" placeholder="Search Users">
                <select id="userDropdown">
                    <option value="" selected>Select User</option>
                    {% for user in users %}<option value="{{ user.id }}">{{ user.username }}</option>{% endfor %}
                </select>
                <button id="showUserDetails">Show User Details</button>
            {% else %}
                <p>No users available.</p>
            {% endif %}
        </div>
    </div>
    <div id="user-details-placeholder"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var bookDropdown = document.getElementById('bookDropdown');
            var bookSearchInput = document.getElementById('bookSearch');
            var userDropdown = document.getElementById('userDropdown');
            var userSearch = document.getElementById('userSearch');
            
            var bookDetailsUrl = document.getElementById('showBookDetails').getAttribute('data-book-details-url');
            var addNewBookButton = document.getElementById('addNewBook');

            // Filter book dropdown based on search input
            bookSearchInput.addEventListener('input', function() {
                var searchTerm = this.value.toLowerCase();
                var options = bookDropdown.options;
                var foundMatch = false;

                for (var i = 1; i < options.length; i++) {
                    var bookTitle = options[i].text.toLowerCase();
                    if (bookTitle.includes(searchTerm)) {
                        options[i].style.display = "block";
                        bookDropdown.selectedIndex = i; // Autofill with first matching book
                        foundMatch = true;
                        break; // Stop after finding the first match
                    } else {
                        options[i].style.display = "none";
                    }
                }
                if (!foundMatch) {
                    bookDropdown.selectedIndex = 0; // Reset to "Select Book"
                    alert("Book not found."); // Notify user if no match found
                } else {
                    // Trigger change event to simulate user selection
                    bookDropdown.dispatchEvent(new Event('change'));
                }
            });

            // Handle show book details button click
            document.getElementById('showBookDetails').addEventListener('click', function() {
                var selectedBookId = bookDropdown.value;
                if (selectedBookId) {
                    var url = bookDetailsUrl.replace('0', selectedBookId);
                    window.open(url, '_popup', 'width=800,height=600');
                } else {
                    alert("Please select a book.");
                }
            });

            // Filter user dropdown based on search input
            userSearch.addEventListener('input', function() {
                var searchTerm = this.value.toLowerCase();
                var options = userDropdown.options;

                for (var i = 1; i < options.length; i++) {
                    var username = options[i].text.toLowerCase();
                    if (username.startsWith(searchTerm)) {
                        options[i].style.display = "block";
                        userDropdown.selectedIndex = i; // Autofill with first matching user
                        return; // Stop after finding the first match
                    } else {
                        options[i].style.display = "none";
                    }
                }

                // If no match found, reset to "Select User"
                userDropdown.selectedIndex = 0;
            });

            // Handle search button click for users (optional)
            document.getElementById('showUserDetails').addEventListener('click', function() {
                var selectedUserId = userDropdown.value;
                if (selectedUserId) {
                    var url = "{% url 'user_details' %}?id=" + selectedUserId;
                    window.open(url, '_popup', 'width=600,height=400');
                } else {
                    alert("Please select a user.");
                }
            });

        // Handle add new book button click
        addNewBookButton.addEventListener('click', function() {
            var url = "{% url 'add_book' %}";
            // Define the size and attributes of the new window
            var newWindow = window.open(url, '_blank', 'width=800,height=600,top=100,left=100');
            // Focus on the new window
            newWindow.focus();
        });

            // ... other existing functions ...
        });
    </script>
{% endblock %}
